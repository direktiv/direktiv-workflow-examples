#
# This is the master workflow for the password rotation medium article
# The workflow has the following inputs:
# {
#    "ip": "3.26.24.101",
#    "user": "wwonigkeit",
#    "vault": "hashicorp",
#    "type": "linux"
# }
#
description: The master workflow to rotate passwords for specific device or application endpoints
states:
#
# First state definition, generate an event for the correct Vault application to be used
# Definitions so far:
#   - HashiCorp Vault (hashicorp)
#   - CyberArk (cyberark)
#   - AWS Secrets Manager (awssm)
#   - GCP Key Management Service (gcpkms)
#   - Azure Key Vault (azurekv)
#   - ManageEngine Password Manager (manageengine)
#
# Next state will generate a lookup event to the specific vault workflow. The context is 
# based on the selection in the previous state
#
- id: validate-input
  type: validate
  schema:
    title: Change Password Inputs
    type: object
    required:
    - ip
    properties:
      ip:
        type: string
        title: IP address
        default: "3.26.24.101"
      user:
        type: string
        title: Username
        default: "wwonigkeit"
      vault:
        type: string
        title: Vault Store
        default: "hashicorp"
      type:
        type: string
        title: Endpoint Type
        default: "linux"
  transition: generate-lookup

#
# This initial state will send an event which contains the input to the workflow. The event will be processed
# by the appropriate lookup workflow (which is contained in the directory under the specific vault software)
# example:
#       -> vaults\hashicorp\hashicorp-lookup
#
- id: generate-lookup
  type: generateEvent
  # log: jq(.)
  event:
    type: com.direktiv.vault.lookup.request
    source: rotate-passwords
    data: jq(.)
    context:
      vault: jq(.vault)
      ip: jq(.ip)
  transition: wait-for-update

#
# This state now waits for the return event from any of the subflows calling the vaults
# to extract the old passwords and generate a new passwords from the vault
#
- id: wait-for-update
  type: eventXor
  timeout: PT30S
  events:
    - transition: workflow-complete
      event:
        type: com.direktiv.vault.update.complete
    - transition: workflow-failure
      event:
        type: com.direktiv.vault.lookup.failure
    - transition: workflow-failure
      event:
        type: com.direktiv.vault.generate.failure
    - transition: workflow-failure
      event:
        type: com.direktiv.vault.update.failure
    - transition: workflow-failure
      event:
        type: com.direktiv.endpoint.change.failure
    - transition: workflow-failure
      event:
        type: com.direktiv.endpoint.verify.failure

#
# Handle the failure event from the update
#
- id: workflow-failure
  type: noop
  log: 'Failure occured jq(.)'

#
# Handle the success event from the password rotation process
#
- id: workflow-complete
  type: noop
  log: "Success! All of the password rotation components have completed within 30 seconds"
